<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <title>用户管理</title>
</head>

<body>
    <div id="app">
        <el-card :body-style="{ padding: '0px' }">
            <div slot="header">
                <span>
                    <center><span>
                            <h1>{{id?"用户编辑":"新建用户"}}</h1>
                        </span></center>
                </span>
            </div>
            <el-form :model="userInfo" label-width="80px" ref="userInfo" :rules="rule">
                <el-form-item label="用户名" prop="Name">
                    <el-input v-model="userInfo.Name"></el-input>
                </el-form-item>

                <el-form-item label="密码" prop="PWD">
                    <el-input type="password" v-model="userInfo.PWD"></el-input>
                </el-form-item>

                <el-form-item label="确认密码" :rules="rule.PWDconfirm">
                    <el-input type="password" v-model="PWDconfirm"></el-input>
                </el-form-item>

                <el-form-item label="手机号码" prop="Tel">
                    <el-input v-model="userInfo.Tel"></el-input>
                </el-form-item>

                <el-form-item label="电子邮箱" prop="eMail">
                    <el-input v-model="userInfo.eMail"></el-input>
                </el-form-item>


                <el-form-item label="关联角色" prop="Role">
                    <el-select v-model="userInfo.Role">
                        <el-option v-for="item in roles" :key="item._id" :label="item.name" :value="item._id">
                        </el-option>
                    </el-select>
                </el-form-item>


                <el-form-item>
                    <el-button type="primary" @click="onSubmit('userInfo')">立即创建</el-button>
                    <el-button @click="goback">取消</el-button>
                </el-form-item>
            </el-form>
        </el-card>
    </div>
</body>
<script>
    let vm = new Vue({
        el: "#app",
        data() {
            return {
                BaseUrl: "http://127.0.0.1:3000",
                id: undefined,
                userInfo: {
                    Name: "",
                    PWD: "",
                    Tel: "",
                    eMail: "",
                    Role: null
                },
                PWDconfirm: "",
                confirm: {
                    cu1: false,
                    cu2: false,
                },
                roles: [],
                rule: {
                    Name: [{
                        required: true,
                        message: '请输入用户名',
                        trigger: 'blur'
                    }, {
                        min: 2,
                        max: 5,
                        message: '长度在 2 到 5 个字符'
                    }, {
                        pattern: /^[\u4E00-\u9FA5]+$/,
                        message: '用户名只能为中文'
                    }
                        //{ pattern:/^[a-zA-Z]w{1,4}$/, message: '以字母开头，长度在2-5之间， 只能包含字符、数字和下划线'}
                    ],
                    PWD: [
                        { required: true, message: '请输入密码', trigger: 'change' }
                    ],
                    Role: [
                        { required: true, message: '请输入内容', trigger: 'change' }
                    ],
                    PWDconfirm: [
                        { required: true, message: '请输入内容', trigger: 'change' }
                    ],
                    eMail: [{
                        required: true,//是否必填
                        message: '请输入邮箱地址',//错误提示信息
                        trigger: 'blur'//检验方式（blur为鼠标点击其他地方，）
                    }, {
                        type: 'email',//要检验的类型（number，email，date等）
                        message: '请输入正确的邮箱地址',
                        trigger: ['blur', 'change']
                    }
                    ],
                    Tel: [{
                        required: true,
                        pattern: /^1[34578]\d{9}$/,//可以写正则表达式呦呦呦
                        message: '目前只支持中国大陆的手机号码',
                        trigger: 'blur'
                    }]
                }
            }
        },
        methods: {
            async getRoles() {
                let e = await axios.get(`${this.BaseUrl}/role/lists`)
                this.roles = e.data
            },
            async register() {
                let e = await axios.post(`${this.BaseUrl}/user/add`, this.userInfo)
                const h = this.$createElement;
                if (e.data.state === 'success') {
                    this.$msgbox({
                        title: "注册成功",
                        message: h('p', null, [
                            h('span', null, '该用户的登陆用ID为：'),
                            h('i', { style: 'color: teal' }, e.data.UID),
                            h('div', { style: 'color: red' }, '请牢记！')
                        ]),
                        beforeClose: (action, instance, done) => {
                            instance.confirmButtonText = 'waiting...';
                            setTimeout(() => {
                                this.goback()
                                done()
                            }, 500)
                        }
                    })
                } else {
                    this.$msgbox({
                        title: "注册失败",
                        message: h('p', null, [
                            h('div', { style: 'color: red' }, '注册信息有误或不通过！'),
                        ])
                    })
                }
            },
            goback() {
                window.location.href = `${this.BaseUrl}/pic/userlist`
            },
            onSubmit(formName) {
                this.$refs[formName].validate((valid) => {
                    const h = this.$createElement;
                    if (this.userInfo.PWD === this.PWDconfirm) {
                        if (valid) {
                            this.register()
                        } else {
                            this.$msgbox({
                                title: "提交失败",
                                message: h('p', null, [
                                    h('div', { style: 'color: red' }, '请正确输入内容'),
                                ])
                            })
                            return false;
                        }
                    } else {
                        this.$msgbox({
                            title: "提交失败",
                            message: h('p', null, [
                                h('div', { style: 'color: red' }, '两次输入的密码不相同'),
                            ])
                        })
                        return false;
                    }
                });
            },
            async isEdit() {
                let t = window.location.href
                let r = t.split(':')
                if (r.length == 4) {
                    this.id = r.slice(-1)[0]
                    let e = await axios.get(`${this.BaseUrl}/user/list/${this.id}`)
                    this.userInfo = e.data
                }
            }
        },
        watch: {
            'PWDconfirm': {
                handler(n, o) {
                    this.confirm.cu1 = n == this.userInfo.PWD
                }
            }
        },
        mounted() {
            this.getRoles()
            this.isEdit()
        },
    })
</script>


<style>
    * {
        margin: 0;
        padding: 0;
        font-family: -apple-system, "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "WenQuanYi Micro Hei", "Microsoft Yahei", sans-serif;
    }

    .el-card {
        width: 800px;
    }

    #app {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .el-row {
        margin: 20px 0px;
        padding: 0px 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .el-row .el-col {
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 800;
        line-height: 3rem;
    }

    .el-form {
        margin-top: 10px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .el-form-item {
        width: 60%;
    }

    .el-select {
        width: 100%;
    }
</style>

</html>